{{ define "main" }}

{{ partial "archive-toc.html" . }}

<hr class="archive-ruler">

{{ .Scratch.Set "taxonomy" "" }}
{{ .Scratch.Set "taxonomyType" "" }}
<h1 class="page-title">
    {{ if eq .Path "/categories" }}
    Categoriesüò∫
    {{-  .Scratch.Set "taxonomy" .Site.Taxonomies.categories -}}
    {{-  .Scratch.Set "taxonomyType" "categories" -}}
    {{ else if eq .Path "/series" }}
    Seriesüìö
    {{-  .Scratch.Set "taxonomy" .Site.Taxonomies.series -}}
    {{-  .Scratch.Set "taxonomyType" "series" -}}
    {{ else }}
    Tagsüè∑Ô∏è
    {{-  .Scratch.Set "taxonomy" .Site.Taxonomies.tags -}}
    {{-  .Scratch.Set "taxonomyType" "tags" -}}
    {{ end }}
    {{- $taxonomy := .Scratch.Get "taxonomy" -}}
    ({{- len $taxonomy -}})
</h1>

{{- $taxonomyType := .Scratch.Get "taxonomyType" -}}
{{- $taxonomyIcon := "" -}}
{{- if eq $taxonomyType "categories" -}}
{{-   $taxonomyIcon = "üò∫" -}}
{{- else if eq $taxonomyType "series" -}}
{{-   $taxonomyIcon = "üìö" -}}
{{- else -}}
{{-   $taxonomyIcon = "üè∑Ô∏è" -}}
{{- end -}}

{{- $txs := slice -}}
{{- range $name, $t := $taxonomy -}}
{{-   with $.Site.GetPage (printf "/%s/%s" $taxonomyType $name) -}}
{{-     $txDict := dict "Term" $name "Count" (len $t) "Link" .RelPermalink "Mtime" .Lastmod -}}
{{-     $txs = append $txs (slice $txDict) -}}
{{-   end -}}
{{- end -}}

<script>

 /**
    sortListByData(document.querySelector('ul.terms'), 'descOrder', 'term', 'termType')

    sortListByData(document.querySelector('ul.terms'), 'count')

    sortListByData(document.querySelector('ul.terms'), 'lastModified')
  */
 function sortListByData(elList, descDataKey, valDataKey, valDataTypeKey) {
     const cmpFns = {
         lexical: function(desc, a, b){
             let res = String(a).localeCompare(String(b));
             if(desc) res *= -1;
             return res;
         },

         numeric: function(desc, a_, b_){
             const a = Number(a_);
             const b = Number(b_);
             let res = 0;
             if(a<b) res = -1;
             else if(a>b) res = 1;
             if (desc)  res *= -1;
             return res;
         },
     };

     //
     const desc = 'true' === String(elList.dataset[descDataKey]);
     const cmpFn = cmpFns[elList.dataset[valDataTypeKey]];

     Array.from(elList.getElementsByTagName("LI"))
          .sort((a, b) => cmpFn(desc, a.dataset[valDataKey], b.dataset[valDataKey]))
          .forEach(li => elList.appendChild(li));
 }

 function doSortTerms(){
     const el = document.querySelector('ul.terms');
     const by = String(el.dataset['sortBy']);
     sortListByData(el, 'descOrder', by, by + 'Type');
 }

 function sortTermsBy(by){
     const el = document.querySelector('ul.terms');
     const origSortBy = String(el.dataset['sortBy']);
     el.dataset['sortBy'] = by;
     if (origSortBy === String(by)){
         toggleDesc();
     }
     doSortTerms();
 }

 function toggleDesc(){
     const el = document.querySelector('ul.terms');
     if(String(el.dataset['descOrder']) === 'true'){
         el.dataset['descOrder'] = 'false';
     }else{
         el.dataset['descOrder'] = 'true';
     }
 }

</script>


<button type="button" onclick="sortTermsBy('term')">by-name</button>

<button type="button" onclick="sortTermsBy('count')">by-count</button>

<button type="button" onclick="sortTermsBy('lastModified')">by-last-modified</button>


<section class="section is-fullheight terms">
    <ul class="{{ $taxonomyType }} terms"
        data-desc-order="true"
        data-sort-by="term"
        data-term-type="lexical"
        data-count-type="numeric"
        data-last-modified-type="numeric" >
	{{ range (sort $txs "Count" "desc") }}
        <li class="tagbutton"
            data-term="{{.Term}}"
            data-count="{{.Count}}"
            data-last-modified="{{.Mtime.Unix}}" >
	    <a href={{ .Link }} title="All pages with {{$taxonomyType}} <i>{{.Term}}</i>">
                {{$taxonomyIcon}} {{.Term}}
            </a>
            <sup>{{.Count}}</sup>
            <br>
            <span class="meta" style="margin-left: 1rem;">
                <time datetime="{{ .Date.Format "2006-01-02" }}" pubdate>
                    {{ dateFormat "2006-01-02" .Mtime }}
                </time>
            </span>
        </li>
        {{ end }}
    </ul>
</section>

<hr class="archive-ruler">

{{ end }}
