{{ define "main" }}

{{ partial "archive-toc.html" . }}

<hr class="archive-ruler">

{{ .Scratch.Set "taxonomy" "" }}
{{ .Scratch.Set "taxonomyType" "" }}
<h1 class="page-title">
    {{ if eq .Path "/categories" }}
    CategoriesğŸ˜º
    {{-  .Scratch.Set "taxonomy" .Site.Taxonomies.categories -}}
    {{-  .Scratch.Set "taxonomyType" "categories" -}}
    {{ else if eq .Path "/series" }}
    SeriesğŸ“š
    {{-  .Scratch.Set "taxonomy" .Site.Taxonomies.series -}}
    {{-  .Scratch.Set "taxonomyType" "series" -}}
    {{ else }}
    TagsğŸ·ï¸
    {{-  .Scratch.Set "taxonomy" .Site.Taxonomies.tags -}}
    {{-  .Scratch.Set "taxonomyType" "tags" -}}
    {{ end }}
    {{- $taxonomy := .Scratch.Get "taxonomy" -}}
    ({{- len $taxonomy -}})
</h1>

{{- $taxonomyType := .Scratch.Get "taxonomyType" -}}
{{- $taxonomyIcon := "" -}}
{{- if eq $taxonomyType "categories" -}}
{{-   $taxonomyIcon = "ğŸ˜º" -}}
{{- else if eq $taxonomyType "series" -}}
{{-   $taxonomyIcon = "ğŸ“š" -}}
{{- else -}}
{{-   $taxonomyIcon = "ğŸ·ï¸" -}}
{{- end -}}

{{- $txs := slice -}}
{{- range $name, $t := $taxonomy -}}
{{-   with $.Site.GetPage (printf "/%s/%s" $taxonomyType $name) -}}
{{-     $txDict := dict "Term" $name "Count" (len $t) "Link" .RelPermalink "Mtime" .Lastmod -}}
{{-     $txs = append $txs (slice $txDict) -}}
{{-   end -}}
{{- end -}}

<script>

 /**
    sortListByData(document.querySelector('ul.terms'), 'descOrder', 'term', 'termType')

    sortListByData(document.querySelector('ul.terms'), 'count')

    sortListByData(document.querySelector('ul.terms'), 'lastModified')
  */
 function sortListByData(elList, elControl, descDataKey, valDataKey, valDataTypeKey) {
     const cmpFns = {
         lexical: function(desc, a, b){
             let res = String(a).localeCompare(String(b));
             if(desc) res *= -1;
             return res;
         },

         numeric: function(desc, a_, b_){
             const a = Number(a_);
             const b = Number(b_);
             let res = 0;
             if(a<b) res = -1;
             else if(a>b) res = 1;
             if (desc)  res *= -1;
             return res;
         },
     };

     //
     const desc = 'true' === String(elControl.dataset[descDataKey]);
     const cmpFn = cmpFns[elControl.dataset[valDataTypeKey]];

     Array.from(elList.getElementsByTagName("LI"))
          .sort((a, b) => cmpFn(desc, a.dataset[valDataKey], b.dataset[valDataKey]))
          .forEach(li => elList.appendChild(li));
 }

 function doSortTerms(){
     const elList = document.querySelector('ul.terms');
     const elControl = document.querySelector('.sort-terms-control');
     const by = String(elControl.dataset['sortBy']);
     sortListByData(elList, elControl, 'descOrder', by, by + 'Type');
     applyToSortOrderIndicator(elControl);
 }

 function sortTermsBy(by){
     const el = document.querySelector('.sort-terms-control');
     const origSortBy = String(el.dataset['sortBy']);
     el.dataset['sortBy'] = by;
     if (origSortBy === String(by)){
         toggleDesc();
     }
     doSortTerms();
 }

 function toggleDesc(){
     const el = document.querySelector('.sort-terms-control');
     if(String(el.dataset['descOrder']) === 'true'){
         el.dataset['descOrder'] = 'false';
     }else{
         el.dataset['descOrder'] = 'true';
     }
 }

 function applyToSortOrderIndicator(elControl){
     // hide all
     document.querySelectorAll('.sort-order-indicator').forEach(i => i.style.display='none');

     // select one
     const kebabize = str => {
         return str.split('').map((letter, idx) => {
             return letter.toUpperCase() === letter
                  ? `${idx !== 0 ? '-' : ''}${letter.toLowerCase()}`
                  : letter;
         }).join('');
     }

     const sortBy = kebabize(String(elControl.dataset['sortBy']));
     const desc = String(elControl.dataset['descOrder']) === 'true';
     const selector = ".sort-terms-btn.by-" + sortBy + " > .sort-order-indicator." + (desc ? "desc" : "asc");

     document.querySelectorAll(selector).forEach(el => el.style.display = 'inline');
 }


</script>


<span class="sort-terms-control"
      data-desc-order="true"
      data-sort-by="count"
      data-term-type="lexical"
      data-count-type="numeric"
      data-last-modified-type="numeric" >
    <button type="button" class="sort-terms-btn by-term" onclick="sortTermsBy('term')">
        by-name
        <span class="sort-order-indicator asc">ğŸ”¼</span>
        <span class="sort-order-indicator desc">ğŸ”½</span>
    </button>

    <button type="button" class="sort-terms-btn by-count" onclick="sortTermsBy('count')">
        by-count
        <span class="sort-order-indicator asc">ğŸ”¼</span>
        <span class="sort-order-indicator desc" style="display:inline;">ğŸ”½</span>
    </button>

    <button type="button" class="sort-terms-btn by-last-modified" onclick="sortTermsBy('lastModified')">
        by-last-modified
        <span class="sort-order-indicator asc">ğŸ”¼</span>
        <span class="sort-order-indicator desc">ğŸ”½</span>
    </button>
</span>


<section class="section is-fullheight terms">
    <ul class="{{ $taxonomyType }} terms">
 	{{ range (sort $txs "Count" "desc") }}
        <li class="tagbutton"
            data-term="{{.Term}}"
            data-count="{{.Count}}"
            data-last-modified="{{.Mtime.Unix}}" >
	    <a href={{ .Link }} title="All pages with {{$taxonomyType}} <i>{{.Term}}</i>">
                {{$taxonomyIcon}} {{.Term}}
            </a>
            <sup>{{.Count}}</sup>
            <br>
            <span class="meta" style="margin-left: 1rem;">
                <time datetime="{{ .Date.Format "2006-01-02" }}" pubdate>
                    {{ dateFormat "2006-01-02" .Mtime }}
                </time>
            </span>
        </li>
        {{ end }}
    </ul>
</section>

<hr class="archive-ruler">

{{ end }}
